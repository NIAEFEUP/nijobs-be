<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>services/application.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    <label for="nav-search" class="overlay">
        <span>&#128269;</span>
        <input type="text" id="nav-search" placeholder="Search" />
    </label>
    
    
    <h2><a href="index.html">Home</a></h2><h2><a href="https://github.com/NIAEFEUP/nijobs-be" target="_blank" class="menu-item" id="repository" >Github repo</a></h2><h3>Classes</h3><ul><li><a href="AccountService.html">AccountService</a><ul class='methods'><li data-type='method' style='display: none;'><a href="AccountService.html#registerAdmin">registerAdmin</a></li></ul></li></ul><h3>Global</h3><ul><li><a href="global.html#checkDuplicatedEmail">checkDuplicatedEmail</a></li><li><a href="global.html#concurrentOffersNotExceeded">concurrentOffersNotExceeded</a></li><li><a href="global.html#ensureArray">ensureArray</a></li><li><a href="global.html#hideInsecureError">hideInsecureError</a></li><li><a href="global.html#or">or</a></li><li><a href="global.html#startServer">startServer</a></li><li><a href="global.html#valuesInSet">valuesInSet</a></li><li><a href="global.html#when">when</a></li></ul>
    
</nav>

<div id="main">
    
    <h1 class="page-title">services/application.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import CompanyApplication, { CompanyApplicationRules } from "../models/CompanyApplication.js";
import hash from "../lib/passwordHashing.js";
import AccountService from "./account.js";
import EmailService from "../lib/emailService.js";
import {
    NEW_COMPANY_APPLICATION_ADMINS,
    NEW_COMPANY_APPLICATION_COMPANY,
    APPROVAL_NOTIFICATION,
    REJECTION_NOTIFICATION,
} from "../email-templates/companyApplicationApproval.js";
import config from "../config/env.js";

export class CompanyApplicationNotFound extends Error {
    constructor(msg) {
        super(msg);
    }
}

export class CompanyApplicationAlreadyReviewed extends Error {
    constructor(msg) {
        super(msg);
    }
}

export class CompanyApplicationEmailAlreadyInUse extends Error {
    constructor(msg) {
        super(msg);
    }
}

class CompanyApplicationService {

    async create({
        email, password, companyName, motivation,
    }) {
        const application = await CompanyApplication.create({
            email,
            password: await hash(password),
            companyName,
            motivation,
            submittedAt: Date.now(),
        });

        await EmailService.sendMail({
            to: config.mail_from,
            ...NEW_COMPANY_APPLICATION_ADMINS(application.email, companyName, motivation)
        });

        await EmailService.sendMail({
            to: application.email,
            ...NEW_COMPANY_APPLICATION_COMPANY(companyName, application._id.toString())
        });

        return application.toObject();
    }

    async findById(id) {
        const company = await CompanyApplication.findById(id).exec();
        return company;
    }

    /**
     *
     * @param {*} limit - Number of documents to return
     * @param {*} offset - where to start the query (pagination - how many documents to skip, NOT how many pages to skip)
     *
     * @returns {applications, totalDocCount}
     */
    async findAll(limit, offset, sortingOptions) {

        const totalDocCount = await CompanyApplication.estimatedDocumentCount();

        return {
            totalDocCount,
            applications:
                [...(await CompanyApplication.find({})
                    .sort(sortingOptions || { submittedAt: "desc" })
                    .skip(offset)
                    .limit(limit)
                    .exec()
                )]
                    .map((application) => application.toObject()),

        };
    }

    buildCompanyNameFilter(companyNameFilter) {
        return {
            // This allows for partial text matching.
            // If only full-text is needed, use $text query instead, which uses
            // a text index and is more performant
            companyName: new RegExp(companyNameFilter, "gi"),
        };
    }

    buildSubmissionDateFilter(submissionDateFilter) {
        const filter = { $and: [] };

        if (submissionDateFilter.to) {
            filter["$and"].push({ submittedAt: { "$lte": submissionDateFilter.to } });
        }
        if (submissionDateFilter.from) {
            filter["$and"].push({ submittedAt: { "$gte": submissionDateFilter.from } });
        }

        return filter;
    }

    buildFiltersQuery({
        companyName,
        submissionDateFrom,
        submissionDateTo,
    }) {
        const filterQueries = [];

        if (companyName) filterQueries.push(this.buildCompanyNameFilter(companyName));

        if (submissionDateFrom || submissionDateTo)
            filterQueries.push(this.buildSubmissionDateFilter({ from: submissionDateFrom, to: submissionDateTo }));

        return filterQueries;
    }

    /**
     * @param {*} limit - Number of documents to return
     * @param {*} offset - where to start the query (pagination - how many documents to skip, NOT how many pages to skip)
     * @param {*} filters - object with optional properties: state, submissionDate, companyName
     * {
     *      companyName: String
     *      submissionDate: { - only one of the properties is necessary, but you can use both to define interval
     *          from: Date
     *          to: Date
     *      }
     *      state: String | Array - String for exact match, Array to provide set of options
     * }
     * @returns {applications, totalDocCount}
     */
    async find(filters, limit, offset, sortingOptions) {

        const { state: stateFilter, ...queryFilters } = { ...filters };

        if (!filters || Object.keys(filters).length === 0) return this.findAll(limit, offset, sortingOptions);

        const docCount = await CompanyApplication.estimatedDocumentCount();

        // Using .skip().limit() can be problematic if we get big data,
        // Once problems appear, consider using .cursor API

        return {
            docCount,
            applications:
                (await CompanyApplication.find(
                    Object.keys(queryFilters).length ? {
                        $and: this.buildFiltersQuery(queryFilters),
                    } : {})
                    .sort(sortingOptions || { submittedAt: "desc" })
                    .skip(offset)
                    .limit(limit)
                    .exec()
                )
                    .map((application) => application.toObject())
                    .filter((application) => (stateFilter) ?
                        application.state === stateFilter ||
                        stateFilter.includes(application.state)
                        : true
                    ),
        };
    }

    async approve(id, options) {

        const application = await CompanyApplication.findById(id, {}, options);
        if (!application) throw new CompanyApplicationNotFound(CompanyApplicationRules.MUST_EXIST_TO_APPROVE.msg);
        try {
            application.approve();
        } catch (e) {
            console.error(e);
            throw new CompanyApplicationAlreadyReviewed(CompanyApplicationRules.CANNOT_REVIEW_TWICE.msg);
        }

        try {
            const account = await (new AccountService()).registerCompany(application.email, application.password, application.companyName);

            await EmailService.sendMail({
                to: application.email,
                ...APPROVAL_NOTIFICATION(application.companyName),
            });

            return { application, account };

        } catch (err) {
            console.error(`Error creating account for approved Company Application, rolling back approval of ${application._id}`, err);
            application.undoApproval();
            if (err.name === "MongoServerError" &amp;&amp; /E11000\s.*collection:\s.*\.accounts.*/.test(err.errmsg)) {
                throw new CompanyApplicationEmailAlreadyInUse(CompanyApplicationRules.EMAIL_ALREADY_IN_USE.msg);
            } else {
                throw err;
            }
        }
    }

    async reject(id, reason, options) {
        const application = (await CompanyApplication.findById(id, {}, options));
        if (!application) throw new CompanyApplicationNotFound(CompanyApplicationRules.MUST_EXIST_TO_REJECT.msg);
        try {
            application.reject(reason);

            await EmailService.sendMail({
                to: application.email,
                ...REJECTION_NOTIFICATION(application.companyName),
            });

            return application.toObject();
        } catch (e) {
            console.error(e);
            throw new CompanyApplicationAlreadyReviewed(CompanyApplicationRules.CANNOT_REVIEW_TWICE.msg);
        }
    }
}

export default CompanyApplicationService;
</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 4.0.2</a> on Thu Jul 27 2023 20:37:38 GMT+0100 (Western European Summer Time) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>

<script src="scripts/search.js" defer></script>


<script src="scripts/collapse.js" defer></script>


    <script src="documentation/code/template/static"></script>
    
</body>
</html>
