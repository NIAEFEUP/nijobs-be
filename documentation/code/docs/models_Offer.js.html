<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>models/Offer.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    <input type="text" id="nav-search" placeholder="Search" />
    
    
    <h2><a href="index.html">Home</a></h2><h2><a href="https://github.com/NIAEFEUP/nijobs-be" target="_blank" class="menu-item" id="repository" >Github repo</a></h2><h3>Classes</h3><ul><li><a href="AccountService.html">AccountService</a><ul class='methods'><li data-type='method' style='display: none;'><a href="AccountService.html#registerAdmin">registerAdmin</a></li></ul></li></ul><h3>Global</h3><ul><li><a href="global.html#checkDuplicatedEmail">checkDuplicatedEmail</a></li><li><a href="global.html#concurrentOffersNotExceeded">concurrentOffersNotExceeded</a></li><li><a href="global.html#ensureArray">ensureArray</a></li><li><a href="global.html#hideInsecureError">hideInsecureError</a></li><li><a href="global.html#or">or</a></li><li><a href="global.html#startServer">startServer</a></li><li><a href="global.html#valuesInSet">valuesInSet</a></li><li><a href="global.html#when">when</a></li></ul>
    
</nav>

<div id="main">
    
    <h1 class="page-title">models/Offer.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import mongoose from "mongoose";

import JobTypes from "./constants/JobTypes.js";
import { FieldTypes, MIN_FIELDS, MAX_FIELDS } from "./constants/FieldTypes.js";
import { TechnologyTypes, MIN_TECHNOLOGIES, MAX_TECHNOLOGIES } from "./constants/TechnologyTypes.js";
import PointSchema from "./Point.js";
import { MONTH_IN_MS, OFFER_MAX_LIFETIME_MONTHS } from "./constants/TimeConstants.js";
import { noDuplicatesValidator, lengthBetweenValidator, validImageURL, validApplyURL } from "./modelUtils.js";
import OfferConstants from "./constants/Offer.js";
import { concurrentOffersNotExceeded, maxHTMLContentLength } from "../api/middleware/validators/validatorUtils.js";

const { Schema, Types } = mongoose;

const OfferSchema = new Schema({
    title: { type: String, maxlength: OfferConstants.title.max_length, minlength: OfferConstants.title.min_length, required: true },
    publishDate: {
        type: Date,
        required: true,
        validate: [
            validatePublishDate,
            "`publishDate` must be earlier than `publishEndDate`",
        ],
    },

    publishEndDate: {
        type: Date,
        required: true,
        validate: [
            validateEndDate,
            `\`publishEndDate\` must not differ from \`publishDate\` by more than ${OFFER_MAX_LIFETIME_MONTHS} months`,
        ],
    },

    jobMinDuration: {
        type: Number,
        required: true,
    },
    jobMaxDuration: {
        type: Number,
        required: true,
        validate: [
            validateJobMaxDuration,
            "`jobMaxDuration` must be larger than `jobMinDuration`",
        ],
    },
    jobStartDate: { type: Date },
    description: {
        type: String,
        required: true,
        validator: validateDescription
    },

    contacts: {
        type: [String],
        required: true,
        validate: [
            (val) => val.length >= 1,
            "There must be at least one contact.",
        ],
    },

    isPaid: { type: Boolean },
    vacancies: { type: Number, min: OfferConstants.vacancies.min },
    jobType: { type: String, required: true, enum: JobTypes },
    fields: {
        type: [{ type: String, enum: FieldTypes }],
        required: true,
        validate: (val) => lengthBetweenValidator(val, MIN_FIELDS, MAX_FIELDS) &amp;&amp; noDuplicatesValidator(val),
    },
    technologies: {
        type: [{ type: String, enum: TechnologyTypes }],
        required: true,
        validate: (val) => lengthBetweenValidator(val, MIN_TECHNOLOGIES, MAX_TECHNOLOGIES) &amp;&amp; noDuplicatesValidator(val),
    },
    hiddenReason: {
        type: String,
        enum: OfferConstants.HiddenOfferReasons,
    },
    adminReason: {
        type: String,
    },
    isHidden: {
        type: Boolean,
        default: false
    },
    isArchived: {
        type: Boolean,
        default: false
    },
    owner: {
        type: Types.ObjectId,
        ref: "Company",
        required: true,
        validator: validateOwnerConcurrentOffers,
    },
    requirements: {
        type: [String],
        required: true,
        validate: [
            (val) => val.length >= 1,
            "There must be at least one requirement"
        ],
    },
    ownerName: { type: String, required: true },
    ownerLogo: { type: String, required: true, validate: (val) => validImageURL(val) },
    location: { type: String, required: true },
    coordinates: { type: PointSchema, required: false },
    applyURL: { type: String, validate: (val) => validApplyURL(val) },
});

OfferSchema.set("timestamps", true);

OfferSchema.index(
    { title: "text", ownerName: "text", jobType: "text", fields: "text", technologies: "text", location: "text" },
    { name: "Search index", weights: { title: 10, ownerName: 5, jobType: 5, location: 5, fields: 5, technologies: 5 } }
);

// Checking if the publication date is less than or equal than the end date.
function validatePublishDate(value) {
    return value &lt;= this.publishEndDate;
}

function validateEndDate(value) {
    return validatePublishEndDateLimit(this.publishDate, value);
}

export function validatePublishEndDateLimit(publishDate, publishEndDate) {

    // Milisseconds from publish date to end date (Offer is no longer valid)
    const timeDiff = publishEndDate.getTime() - publishDate.getTime();
    const diffInMonths = timeDiff / MONTH_IN_MS;

    return diffInMonths &lt;= OFFER_MAX_LIFETIME_MONTHS;
}

// jobMaxDuration must be larger than jobMinDuration
function validateJobMaxDuration(value) {
    return value >= this.jobMinDuration;
}

function validateOwnerConcurrentOffers(value) {
    return concurrentOffersNotExceeded(this.constructor)(value, this.publishDate, this.publishEndDate);
}

function validateDescription(value) {
    return maxHTMLContentLength(OfferConstants.description.max_length)(value);
}

/**
 * Currently active Offers (publish date was before Date.now and end date is after Date.now)
 */
OfferSchema.statics.filterCurrent = () => ({
    publishDate: {
        $lte: new Date(Date.now()),
    },
    publishEndDate: {
        $gt: new Date(Date.now()),
    },
});
OfferSchema.query.current = function() {
    return this.where(this.model.filterCurrent());
};

/**
 * Currently active and non-hidden Offers
 */
OfferSchema.statics.filterNonHidden = () => ({ isHidden: false });
OfferSchema.query.withoutHidden = function() {
    return this.where(this.model.filterNonHidden());
};

/**
 * Currently active and non-archived Offers
 */
OfferSchema.query.withoutArchived = function() {
    return this.where({ isArchived: false });
};

const Offer = mongoose.model("Offer", OfferSchema);

// Useful for testing correct field implementation
// console.log("DBG: ", OfferSchema.path("location"));

export default Offer;
</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 4.0.2</a> on Thu Jul 20 2023 14:15:39 GMT+0100 (Western European Summer Time) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>

<script src="scripts/search.js" defer></script>


<script src="scripts/collapse.js" defer></script>


</body>
</html>
